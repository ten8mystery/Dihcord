<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini DM App (Dark Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
        }
        /* Custom scrollbar for message area */
        .message-area::-webkit-scrollbar {
            width: 6px;
        }
        .message-area::-webkit-scrollbar-thumb {
            background: #4b5563; /* Darker thumb */
            border-radius: 3px;
        }
        .message-area::-webkit-scrollbar-track {
            background: transparent;
        }
        .user-id-code {
            font-size: 0.65rem; /* Very small text for the long ID */
            word-break: break-all;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Loading Screen -->
    <div id="loading-screen" class="absolute inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-400">Connecting to the matrix...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="w-full max-w-5xl h-[80vh] bg-gray-800 shadow-2xl rounded-2xl flex overflow-hidden hidden text-gray-100">

        <!-- Sidebar: User List & Search -->
        <div id="sidebar" class="w-full sm:w-1/3 border-r border-gray-700 flex flex-col transition-all duration-300">
            
            <!-- Sidebar Header -->
            <header class="p-4 border-b bg-indigo-700 text-white flex justify-between items-center">
                <h2 class="text-xl font-bold">Users</h2>
                <div id="user-profile-info" class="text-sm cursor-pointer hover:bg-indigo-800 p-1 rounded-lg transition-colors" onclick="showCurrentProfileModal()">
                    <span id="current-username"></span>
                </div>
            </header>

            <!-- Search Input -->
            <div class="p-4 border-b border-gray-700 bg-gray-900">
                <input type="text" id="user-search-input" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-sm text-gray-200 placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search users by name...">
            </div>

            <!-- User List -->
            <div id="users-list" class="flex-grow overflow-y-auto">
                <!-- Users will be listed here -->
                <p class="p-4 text-center text-gray-400 text-sm">Loading users...</p>
            </div>
        </div>

        <!-- Chat Area: Messages and Input -->
        <div id="chat-area" class="w-full sm:w-2/3 flex flex-col hidden sm:flex">
            
            <!-- Chat Header -->
            <header id="chat-header" class="p-4 border-b border-gray-700 bg-gray-700 flex items-center">
                <button id="back-button" class="sm:hidden text-gray-300 mr-3" onclick="closeChat()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </button>
                <div id="recipient-info">
                    <h3 class="text-lg font-semibold text-gray-100">Select a User</h3>
                    <p class="text-sm text-gray-400">Start a new conversation</p>
                </div>
            </header>

            <!-- Message Display -->
            <div id="messages-display" class="message-area flex-grow p-4 space-y-4 overflow-y-auto flex flex-col-reverse">
                <p id="chat-placeholder" class="text-center text-gray-500 mt-20">Select a user on the left to start direct messaging.</p>
                <!-- Messages will be injected here -->
            </div>

            <!-- Message Input -->
            <div id="message-input-area" class="p-4 border-t border-gray-700 bg-gray-800 hidden">
                <form id="message-form" class="flex">
                    <input type="text" id="message-input" class="flex-grow p-3 bg-gray-700 border border-gray-600 text-gray-100 rounded-l-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type a message..." required autocomplete="off">
                    <button type="submit" class="bg-indigo-600 text-white p-3 rounded-r-xl font-semibold hover:bg-indigo-700 transition-colors disabled:bg-indigo-400" disabled id="send-button">
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals (Hidden by default) -->

    <!-- 1. Profile Setup Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-gray-100">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">Set Up Your Profile</h2>
            <p class="text-gray-400 mb-6">Please choose a username. This will be visible to others.</p>
            <form id="profile-form">
                <input type="text" id="username-input" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 text-gray-100" placeholder="Enter your username (e.g., JaneDoe123)" required maxlength="20">
                <button type="submit" id="save-profile-button" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    Save Profile
                </button>
                <p id="profile-error" class="text-red-400 text-sm mt-2 hidden"></p>
            </form>
            <p class="text-xs text-gray-500 mt-4">Your User ID: <span id="auth-uid" class="user-id-code text-gray-400"></span></p>
        </div>
    </div>

    <!-- 2. Current Profile Display Modal (for visibility) -->
    <div id="current-profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden" onclick="closeCurrentProfileModal(event)">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full text-gray-100" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold text-gray-100 mb-3">Your Profile</h2>
            <p class="text-gray-300 mb-2"><strong>Username:</strong> <span id="modal-current-username" class="font-medium text-indigo-400"></span></p>
            <p class="text-gray-300 mb-4 text-sm"><strong>Your User ID:</strong> <code class="break-all user-id-code text-xs text-gray-400" id="modal-auth-uid"></code></p>
            <button onclick="closeCurrentProfileModal()" class="w-full bg-gray-700 text-gray-100 p-2 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                Close
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, orderBy, limit, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (may be undefined on external hosting)
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Configuration Logic for Robust External Hosting ---

        // Standard configuration for the canvas environment (used as a reliable fallback)
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAeN72Y5DfDR60psO_YkS_H-9PF0bu0QBs",
            authDomain: "dihbackend.firebaseapp.com",
            projectId: "dihbackend",
            storageBucket: "dihbackend.firebasestorage.app",
            messagingSenderId: "136423198603",
            appId: "1:136423198603:web:953bcd9ee925b6664ce98e",
            measurementId: "G-PSGVGZYGTD"
        };
        
        // Use environment's appId or a static ID for external deployment pathing
        const appId = envAppId || 'external-dm-app-id'; 
        let firebaseConfig;

        try {
            // 1. Try to use environment config (for Canvas)
            firebaseConfig = envFirebaseConfig ? JSON.parse(envFirebaseConfig) : FALLBACK_FIREBASE_CONFIG;
        } catch (e) {
            // 2. Fallback if JSON parsing fails (e.g., if env var is missing/malformed)
            console.warn("Could not parse environment config. Using fallback Firebase configuration.");
            firebaseConfig = FALLBACK_FIREBASE_CONFIG;
        }

        let app, db, auth;
        let currentUserId = null;
        let currentUsername = null;
        let currentRecipient = null; 
        let unsubscribeMessages = null;
        let allUsers = []; 

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            setLogLevel('Debug');
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config is missing or invalid.");
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-400">Error: Firebase configuration is missing or invalid.</p>';
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 1. Sign In
            try {
                // Prioritize custom token (Canvas environment)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in (External hosting like Vercel)
                    console.log("No custom auth token found. Signing in anonymously for external deployment.");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-400">Error logging in. Check console for details.</p>';
                return;
            }

            // 2. Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('auth-uid').textContent = user.uid;
                    document.getElementById('modal-auth-uid').textContent = user.uid;
                    loadUserProfile(user.uid);
                } else {
                    console.log("User signed out.");
                    currentUserId = null;
                }
            });
        }

        // --- User Profile Management ---

        function getUserProfileDocRef(userId) {
            // Uses the robustly defined 'appId'
            return doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
        }

        async function loadUserProfile(userId) {
            try {
                const userDocRef = getUserProfileDocRef(userId);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().username) {
                    currentUsername = userDoc.data().username;
                    document.getElementById('current-username').textContent = currentUsername;
                    document.getElementById('modal-current-username').textContent = currentUsername;
                    // Start main app flow
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    startAppListeners();
                } else {
                    // Profile does not exist, show setup modal
                    document.getElementById('loading-screen').classList.add('hidden');
                    showProfileModal();
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputElement = document.getElementById('username-input');
            const username = inputElement.value.trim();
            const errorElement = document.getElementById('profile-error');

            if (!username) {
                errorElement.textContent = "Username cannot be empty.";
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');
            document.getElementById('save-profile-button').disabled = true;

            try {
                // Check if username is already taken (simple query check)
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'users'),
                    where('username', '==', username),
                    limit(1)
                );
                const snapshot = await getDocs(q);

                if (!snapshot.empty && snapshot.docs[0].id !== currentUserId) {
                    errorElement.textContent = `Username "${username}" is already taken. Please choose another.`;
                    errorElement.classList.remove('hidden');
                    document.getElementById('save-profile-button').disabled = false;
                    return;
                }

                // Save profile
                const userDocRef = getUserProfileDocRef(currentUserId);
                await setDoc(userDocRef, {
                    userId: currentUserId,
                    username: username,
                    lastSeen: serverTimestamp(),
                });

                // Success
                loadUserProfile(currentUserId);
                closeProfileModal();

            } catch (error) {
                console.error("Error saving profile:", error);
                errorElement.textContent = "Failed to save profile. Try again.";
                errorElement.classList.remove('hidden');
            } finally {
                document.getElementById('save-profile-button').disabled = false;
            }
        });

        function showProfileModal() {
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-modal').style.pointerEvents = 'auto'; 
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
        }
        
        function showCurrentProfileModal() {
             document.getElementById('current-profile-modal').classList.remove('hidden');
        }

        function closeCurrentProfileModal(event) {
            // Close only if click is on backdrop or close button
            if (!event || event.target.id === 'current-profile-modal') {
                document.getElementById('current-profile-modal').classList.add('hidden');
            }
        }
        document.getElementById('user-profile-info').onclick = showCurrentProfileModal;


        // --- Main App Logic (Listeners and Search) ---

        function startAppListeners() {
            listenForUsers();
            document.getElementById('user-search-input').addEventListener('input', handleUserSearch);
        }
        
        function handleUserSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            renderUsersList(allUsers, searchTerm);
        }

        function listenForUsers() {
            const usersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const q = query(usersCollectionRef, orderBy('lastSeen', 'desc'));

            onSnapshot(q, (snapshot) => {
                allUsers = [];
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Store all users except self
                    if (userData.userId !== currentUserId) {
                        allUsers.push(userData);
                    }
                });
                
                // Get the current search term to re-filter the list
                const searchTerm = document.getElementById('user-search-input')?.value.toLowerCase() || '';
                renderUsersList(allUsers, searchTerm);
                
            }, (error) => {
                console.error("Error listening to users:", error);
            });
        }
        
        function renderUsersList(users, searchTerm = '') {
            const usersListElement = document.getElementById('users-list');
            usersListElement.innerHTML = '';
            
            const filteredUsers = users.filter(userData => {
                return userData.username.toLowerCase().includes(searchTerm);
            });
            
            if (filteredUsers.length === 0 && searchTerm === '') {
                usersListElement.innerHTML = '<p class="p-4 text-center text-gray-500 text-sm">No other users online yet.</p>';
                return;
            } else if (filteredUsers.length === 0 && searchTerm !== '') {
                usersListElement.innerHTML = `<p class="p-4 text-center text-gray-500 text-sm">No users found matching "${searchTerm}".</p>`;
                return;
            }

            filteredUsers.forEach((userData) => {
                const userItem = document.createElement('div');
                // Updated class names for Dark Mode
                userItem.className = 'user-item p-4 border-b border-gray-700 cursor-pointer hover:bg-indigo-900 transition-colors flex justify-between items-center';
                userItem.setAttribute('data-user-id', userData.userId);
                userItem.setAttribute('data-username', userData.username);
                userItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-100">${userData.username}</p>
                        <p class="user-id-code text-indigo-400 mt-1">${userData.userId}</p>
                    </div>
                `;
                userItem.onclick = () => selectRecipient(userData);
                usersListElement.appendChild(userItem);
            });
            
            // Highlight the currently selected recipient
            if (currentRecipient) {
                document.querySelectorAll('.user-item').forEach(item => {
                    if (item.getAttribute('data-user-id') === currentRecipient.userId) {
                        // Dark mode highlight classes
                        item.classList.add('bg-indigo-800', 'hover:bg-indigo-800', 'border-indigo-400', 'border-l-4');
                    } else {
                        item.classList.remove('bg-indigo-800', 'hover:bg-indigo-800', 'border-indigo-400', 'border-l-4');
                    }
                });
            }
        }


        // --- Chat Window Logic ---

        function generateChatId(id1, id2) {
            // Create a consistent chat ID by sorting the two user IDs
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }

        function getMessagesCollectionRef(chatId) {
            return collection(db, 'artifacts', appId, 'public', 'data', 'chats', chatId, 'messages');
        }

        function selectRecipient(recipient) {
            currentRecipient = recipient;

            // Update header with full User ID
            document.getElementById('recipient-info').innerHTML = `
                <h3 class="text-lg font-semibold text-gray-100">${recipient.username}</h3>
                <code class="user-id-code text-sm text-gray-400">${recipient.userId}</code>
            `;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('message-input-area').classList.remove('hidden');
            document.getElementById('send-button').disabled = false;

            // Mobile view handling
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('chat-area').classList.remove('hidden');
            document.getElementById('chat-area').classList.add('flex'); // Ensure it's visible as flex column

            // Highlight the selected user
            renderUsersList(allUsers, document.getElementById('user-search-input').value.toLowerCase());

            listenForMessages();
        }

        function closeChat() {
            // Only for small screens
            if (window.innerWidth < 640) {
                document.getElementById('chat-area').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
            }
        }
        window.addEventListener('resize', () => {
             // If window resized to desktop size, show both
            if (window.innerWidth >= 640) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('chat-area').classList.remove('hidden');
                document.getElementById('chat-area').classList.add('flex');
            }
        });


        function listenForMessages() {
            if (!currentRecipient || !currentUserId) return;

            if (unsubscribeMessages) {
                unsubscribeMessages(); // Stop listening to the previous chat
            }

            const chatId = generateChatId(currentUserId, currentRecipient.userId);
            const messagesRef = getMessagesCollectionRef(chatId);

            const q = query(messagesRef, orderBy('timestamp', 'desc'), limit(50));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messagesDisplay = document.getElementById('messages-display');
                const fragment = document.createDocumentFragment();

                // Clear current messages
                messagesDisplay.innerHTML = '';
                if (document.getElementById('chat-placeholder')) {
                    document.getElementById('chat-placeholder').classList.add('hidden');
                }

                snapshot.docs.reverse().forEach((doc) => { // Reverse to show newest at bottom
                    const message = doc.data();
                    const isSelf = message.senderId === currentUserId;

                    const messageBubble = document.createElement('div');
                    messageBubble.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;
                    messageBubble.innerHTML = `
                        <div class="max-w-xs sm:max-w-md lg:max-w-xl p-3 rounded-xl shadow-md ${isSelf ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-tl-none'}">
                            <p class="font-medium text-xs ${isSelf ? 'text-indigo-200' : 'text-gray-400'}">${isSelf ? currentUsername : currentRecipient.username}</p>
                            <p class="text-sm break-words mt-1">${message.text}</p>
                            <span class="text-xs mt-1 block text-right opacity-75 ${isSelf ? 'text-indigo-200' : 'text-gray-400'}">${message.timestamp ? formatTimestamp(message.timestamp) : 'Sending...'}</span>
                        </div>
                    `;
                    fragment.appendChild(messageBubble);
                });

                messagesDisplay.appendChild(fragment);
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
        }

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputElement = document.getElementById('message-input');
            const messageText = inputElement.value.trim();

            if (!messageText || !currentRecipient || !currentUserId) return;

            try {
                const chatId = generateChatId(currentUserId, currentRecipient.userId);
                const messagesRef = getMessagesCollectionRef(chatId);
                
                // Add the new message
                await addDoc(messagesRef, {
                    senderId: currentUserId,
                    text: messageText,
                    timestamp: serverTimestamp(),
                });

                // Clear input
                inputElement.value = '';

                // Update sender's last seen status (to keep them in the users list)
                const userDocRef = getUserProfileDocRef(currentUserId);
                await setDoc(userDocRef, { lastSeen: serverTimestamp() }, { merge: true });

            } catch (error) {
                console.error("Error sending message:", error);
                console.error("Failed to send message: Check network and database status.");
            }
        });

        // Utility function for formatting timestamp (Firestore Timestamp object)
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                const date = timestamp.toDate();
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            return 'Just now';
        }

        // --- Start Application ---
        initFirebase();
    </script>
</body>
</html>
