<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dihcord (Login Enabled)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font and custom scrollbar for better look -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .message-content img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 4px;
        }
        /* Custom Scrollbar Styling (Webkit only, for a cleaner look) */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1E1F22; /* Sidebar background */
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #444754; /* Darker scroll handle */
            border-radius: 4px;
        }
        .custom-scroll-chat::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll-chat::-webkit-scrollbar-track {
            background: #2B2D31; /* Chat background */
        }
        .custom-scroll-chat::-webkit-scrollbar-thumb {
            background: #444754;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-[#2B2D31] text-gray-100 h-screen overflow-hidden flex">

    <!-- Firebase SDK Imports (Logic remains the same) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel, setDoc, doc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app, db, auth, userId;
        let isAuthReady = false;
        let displayName = ''; 
        let isMediaMode = false;
        let isUserLoggedIn = false; 
        
        // DM/Channel State
        let activeChatId = 'general'; 
        let activeChatName = '# General Chat';
        let dmRecipientId = null; 
        let unsubscribeChat = null; 
        let dmList = []; 

        // --- Core Firebase Initialization and Auth ---

        const initFirebaseAndChat = async () => {
            try {
                // 1. Get Configs (MANDATORY)
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                
                if (firebaseConfigString === '{}' || firebaseConfigString === '') {
                     console.warn("Firebase Config Status: The environment provided an empty or default config string. This will cause the initialization error.");
                }

                setLogLevel('error');
                
                const storedName = localStorage.getItem('chatDisplayName');
                if (storedName) {
                    displayName = storedName;
                }
                
                let firebaseConfig = {};
                try {
                    firebaseConfig = JSON.parse(firebaseConfigString);
                } catch (e) {
                    console.error("Failed to parse Firebase configuration string:", e);
                }

                // 2. Initialize Firebase App
                if (Object.keys(firebaseConfig).length === 0) {
                    const loadingState = document.getElementById('loading-state');
                    if (loadingState) {
                       loadingState.innerHTML = '<div class="flex items-center space-x-2"><svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span class="text-red-500 font-bold">Error: Firebase config is missing.</span></div>';
                    }
                    console.error("Firebase configuration is missing. Cannot initialize Firestore.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Handle Authentication State Change
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isUserLoggedIn = true;
                        isAuthReady = true;
                        
                        await fetchUserProfile(appId, userId);
                        
                        updateDisplayNameUI(); 
                        
                        // Switch from login screen to chat screen
                        document.getElementById('auth-container').classList.add('hidden');
                        document.getElementById('chat-app-container').classList.remove('hidden');
                        
                        console.log("Authenticated. UID:", userId);
                        
                        setupRealtimeListener(activeChatId);
                        setupDmListListener(appId); 
                        

                    } else {
                        userId = null;
                        isUserLoggedIn = false;
                        isAuthReady = false;
                        displayName = '';
                        
                        // Show the login form if not authenticated
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('login-form').classList.remove('hidden');

                        // Attempt sign in with token if available 
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                console.log("Token sign-in failed, showing login form.");
                                document.getElementById('loading-state').classList.add('hidden');
                                document.getElementById('login-form').classList.remove('hidden');
                            }
                        } else {
                            document.getElementById('loading-state').classList.add('hidden');
                            document.getElementById('login-form').classList.remove('hidden');
                        }
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                document.getElementById('loading-state').innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
        }
        
        // --- User Profile Management (Logic remains the same) ---

        const isDisplayNameAvailable = async (appId, newName, currentUserId) => {
            if (!db) return false; 
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where('displayName', '==', newName));
            
            try {
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const existingUserDoc = querySnapshot.docs[0];
                    if (existingUserDoc.id !== currentUserId) {
                        return false; 
                    }
                }
                return true; 
            } catch (e) {
                console.error("Error checking display name availability:", e);
                return false; 
            }
        }
        
        const fetchUserProfile = async (appId, uid) => {
            if (!db) return; 
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
            try {
                const userDoc = await getDoc(userDocRef); 
                if (userDoc.exists()) {
                    displayName = userDoc.data().displayName || 'User' + uid.substring(0, 4);
                } else {
                    displayName = 'User' + uid.substring(0, 4);
                    await setDoc(userDocRef, { 
                        displayName: displayName,
                        createdAt: serverTimestamp(),
                        userId: uid
                    });
                }
                localStorage.setItem('chatDisplayName', displayName);
            } catch (e) {
                console.error("Error fetching/creating user profile:", e);
                displayName = 'Anon' + uid.substring(0, 4);
            }
        }

        const saveUserProfileName = async (appId, uid, newName) => {
             if (!db) return false; 
             const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
             try {
                 await setDoc(userDocRef, { displayName: newName, userId: uid }, { merge: true });
                 return true;
             } catch (e) {
                 console.error("Error saving user profile name:", e);
                 return false;
             }
        }
        
        // --- Login/Sign Up Logic (Logic remains the same) ---

        window.handleAuthAction = async (isSignup) => {
            const emailInput = document.getElementById('auth-email');
            const passwordInput = document.getElementById('auth-password');
            const status = document.getElementById('auth-status');
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            status.textContent = "Processing...";
            status.classList.remove('hidden', 'text-red-500', 'text-green-500');
            status.classList.add('text-indigo-500');

            if (password.length < 6) {
                status.textContent = "Password must be at least 6 characters long.";
                status.classList.remove('text-indigo-500');
                status.classList.add('text-red-500');
                return;
            }

            try {
                if (isSignup) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    status.textContent = "Sign Up Successful! Logging you in...";
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    status.textContent = "Login Successful! Welcome back!";
                }
                status.classList.remove('text-red-500');
                status.classList.add('text-green-500');
                emailInput.value = '';
                passwordInput.value = '';

            } catch (error) {
                console.error("Auth error:", error);
                status.textContent = error.message.replace('Firebase: Error ', '').replace('(auth/', ' (');
                status.classList.remove('text-indigo-500');
                status.classList.add('text-red-500');
            }
        }

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                showNotification("Logged out successfully.", 'green');
                document.getElementById('chat-app-container').classList.add('hidden');
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Logout failed.', 'red');
            }
        }

        // --- Helper Functions (Logic remains the same) ---

        const isImageUrl = (str) => {
            if (!str) return false;
            const urlPattern = /^(https?:\/\/.+)/i;
            const isUrlFormat = urlPattern.test(str);
            const isImageExtension = /\.(gif|jpe?g|tiff|png|webp|bmp)(\?.*)?$/i.test(str);
            return isUrlFormat && isImageExtension;
        }
        
        const getPlaceholderUrl = (text = 'Image Broken') => {
             return `https://placehold.co/200x150/1f2937/d1d5db?text=${encodeURIComponent(text)}`;
        }

        const getDmRoomId = (otherUserId) => {
            if (!userId || !otherUserId) return null;
            const sortedIds = [userId, otherUserId].sort();
            return sortedIds.join('_');
        }

        // --- UI Updates ---

        const updateDisplayNameUI = () => {
            const nameInput = document.getElementById('new-display-name-input');
            const idDisplay = document.getElementById('user-id-display');
            
            if (nameInput) {
                nameInput.value = displayName;
            }
            if (idDisplay && userId) {
                idDisplay.innerHTML = `<span class="font-semibold text-gray-300">${displayName || 'Anonymous'}</span><span class="text-indigo-400 ml-2 font-mono text-[10px] sm:text-xs break-all truncate w-full block">${userId}</span>`;
            }
            updateInputPlaceholder();
        }

        const updateChatHeaderUI = () => {
            const header = document.getElementById('chat-header-name');
            const desc = document.getElementById('chat-header-desc');
            header.textContent = activeChatName;
            desc.textContent = activeChatId === 'general' 
                ? 'A public, real-time chat powered by Firestore, now with image embeds!' 
                : 'A private Direct Message conversation.';
        }

        const updateDmListUI = () => {
            const listContainer = document.getElementById('dm-list-container');
            listContainer.innerHTML = '';
            
            if (dmList.length === 0) {
                 listContainer.innerHTML = `<p class="text-xs text-gray-500 text-center py-2">No active DMs. Start one below!</p>`;
            }

            dmList.forEach(dmRecipient => {
                const recipientId = dmRecipient.recipientId;
                const roomId = getDmRoomId(recipientId);
                const isActive = roomId === activeChatId;
                if (recipientId === userId) return; 

                const buttonClass = isActive 
                    ? 'bg-indigo-600/50 text-white font-semibold' 
                    : 'text-gray-300 hover:bg-[#383A40] transition-colors';

                const dmButton = document.createElement('button');
                dmButton.className = `flex items-center w-full p-2 rounded-lg ${buttonClass}`;
                const dmName = dmRecipient.displayName || `DM: ${recipientId.substring(0, 8)}...`;
                dmButton.onclick = () => switchChat(roomId, `DM: ${dmName}`, recipientId);

                dmButton.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    <span class="truncate text-sm">${dmName}</span>
                `;
                listContainer.appendChild(dmButton);
            });
        }

        window.setDisplayName = async () => {
            const input = document.getElementById('new-display-name-input');
            const status = document.getElementById('name-status');
            let newName = input.value.trim();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (newName.length < 2 || newName.length > 20) {
                status.textContent = "Name must be 2-20 characters long.";
                status.classList.remove('hidden', 'text-green-500');
                status.classList.add('text-red-500', 'block');
                setTimeout(() => status.classList.add('hidden'), 3000);
                return;
            }
            
            newName = newName.replace(/[^\w\s]/gi, '');
            
            const isAvailable = await isDisplayNameAvailable(appId, newName, userId);
            
            if (!isAvailable) {
                status.textContent = "That display name is already taken by another user.";
                status.classList.remove('hidden', 'text-green-500');
                status.classList.add('text-red-500', 'block');
                setTimeout(() => status.classList.add('hidden'), 3000);
                return;
            }
            
            if (await saveUserProfileName(appId, userId, newName)) {
                localStorage.setItem('chatDisplayName', newName);
                displayName = newName;
                updateDisplayNameUI();

                status.textContent = "Display name updated!";
                status.classList.remove('hidden', 'text-red-500');
                status.classList.add('text-green-500', 'block');
            } else {
                status.textContent = "Error updating name.";
                status.classList.remove('hidden', 'text-green-500');
                status.classList.add('text-red-500', 'block');
            }
            setTimeout(() => status.classList.add('hidden'), 3000);
        }

        const updateInputPlaceholder = () => {
            const input = document.getElementById('message-input');
            const button = document.getElementById('media-toggle-button');
            if (!input || !button) return;

            if (isMediaMode) {
                input.placeholder = "PASTE IMAGE URL (.jpg, .png, .gif) and hit Send...";
                button.classList.remove('text-gray-300', 'hover:bg-[#444754]');
                button.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
            } else {
                input.placeholder = `Message ${activeChatName} (Press Enter to send)`;
                button.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                button.classList.add('text-gray-300', 'hover:bg-[#444754]');
            }
        }

        window.toggleMediaMode = () => {
            isMediaMode = !isMediaMode;
            updateInputPlaceholder();
            document.getElementById('message-input').focus();
        }
        
        // --- DM List Management (Logic remains the same) ---
        
        const setupDmListListener = (appId) => {
            if (!db || !isAuthReady || !userId) {
                console.log("DM List Listener skipped: DB or Auth not ready.");
                return;
            }

            const path = `artifacts/${appId}/users/${userId}/dm_recipients`; 
            const dmRef = collection(db, path);
            
            const q = query(dmRef, orderBy('lastContact', 'desc')); 
            
            onSnapshot(q, (snapshot) => {
                dmList = [];
                snapshot.forEach(doc => {
                    dmList.push({ id: doc.id, ...doc.data() });
                });
                updateDmListUI();
            }, (error) => {
                console.error("Error listening to DM list:", error);
            });
        }
        
        const saveDmRecipient = async (initiatorId, recipientId, recipientName) => {
             if (!db) return; 
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                const initiatorPath = `artifacts/${appId}/users/${initiatorId}/dm_recipients`;
                const initiatorDocId = recipientId; 
                
                await setDoc(doc(db, initiatorPath, initiatorDocId), { 
                    recipientId: recipientId, 
                    displayName: recipientName, 
                    lastContact: serverTimestamp()
                }, { merge: true });
                
                const recipientPath = `artifacts/${appId}/users/${recipientId}/dm_recipients`;
                const recipientDocId = initiatorId; 
                
                 await setDoc(doc(db, recipientPath, recipientDocId), { 
                    recipientId: initiatorId, 
                    displayName: displayName, 
                    lastContact: serverTimestamp()
                }, { merge: true });

            } catch (e) {
                console.error("Error saving DM recipient:", e);
            }
        }

        const getUserIdByDisplayName = async (appId, searchName) => {
             if (!db) return null; 
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where('displayName', '==', searchName));
            
            try {
                const querySnapshot = await getDocs(q); 
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].id; 
                }
                return null;
            } catch (e) {
                console.error("Error finding user by display name:", e);
                return null;
            }
        }

        window.startDM = async () => {
            const recipientInput = document.getElementById('dm-recipient-input');
            const recipientName = recipientInput.value.trim();
            recipientInput.value = ''; 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (!recipientName) {
                 showNotification("DM Error: Please enter a display name.", 'red');
                return;
            }
            
            const recipientId = await getUserIdByDisplayName(appId, recipientName);

            if (!recipientId) {
                showNotification(`User '${recipientName}' not found. Check the spelling.`, 'red');
                return;
            }
            
            if (recipientId === userId) {
                 showNotification("DM Error: Cannot DM yourself.", 'red');
                return;
            }

            const roomId = getDmRoomId(recipientId);
            
            saveDmRecipient(userId, recipientId, recipientName);
            switchChat(roomId, `DM: ${recipientName}`, recipientId);

            showNotification(`Starting DM with ${recipientName}...`, 'green');
        }

        window.switchChat = (newChatId, newChatName, recipient = null) => {
            if (!isAuthReady || !userId) {
                showNotification("Authentication not ready. Cannot switch chat.", 'red');
                return;
            }

            if (unsubscribeChat) {
                unsubscribeChat();
            }

            activeChatId = newChatId;
            activeChatName = newChatName;
            dmRecipientId = recipient; 
            
            updateChatHeaderUI();
            updateInputPlaceholder();
            updateDmListUI();
            const messageInput = document.getElementById('message-input');
            if (messageInput) messageInput.focus();
            
            setupRealtimeListener(newChatId); 
            const chatBox = document.getElementById('chat-box');
            if(chatBox) {
                chatBox.innerHTML = `
                    <div id="loading-state-chat" class="p-4 text-center text-indigo-400 animate-pulse">
                        Loading ${newChatName} messages...
                    </div>
                `;
            }
            
            // Update button styles in sidebar
            const generalBtn = document.getElementById('general-channel-button');
            const activeClass = 'bg-indigo-600/50 text-white font-semibold';
            const inactiveClass = 'text-gray-300 hover:bg-[#383A40]';

            if(generalBtn) {
                if (newChatId === 'general') {
                    generalBtn.className = `flex items-center w-full p-2 rounded-lg transition-colors ${activeClass} mb-4`;
                } else {
                    generalBtn.className = `flex items-center w-full p-2 rounded-lg transition-colors ${inactiveClass} mb-4`;
                }
            }
        }


        // --- Firestore Real-time Listener (Logic remains the same) ---

        const setupRealtimeListener = (chatId) => {
            if (!db || !isAuthReady || !userId) {
                 console.log("Firestore Listener skipped: DB or Auth not ready.");
                 return;
            }
            
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let path;
            
            if (chatId === 'general') {
                path = `artifacts/${appId}/public/data/messages`;
            } else {
                path = `artifacts/${appId}/public/data/dms/${chatId}/messages`;
            }

            const messagesRef = collection(db, path);
            const q = query(messagesRef, orderBy('timestamp')); 

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                const loadingState = document.getElementById('loading-state-chat');
                if(loadingState) loadingState.remove();

                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                const chatBox = document.getElementById('chat-box');
                if(chatBox) {
                    const errorMessage = error.message.includes('permission-denied') 
                        ? "ERROR: Permission Denied. Your security rules might be too strict." 
                        : `ERROR: Failed to load chat. Message: ${error.message}`;
                        
                    chatBox.innerHTML = `
                        <div class="p-4 text-center text-red-300 bg-red-900/50 rounded-lg border border-red-500 mx-auto max-w-lg shadow-xl">
                            <strong class="font-bold">Firestore Error:</strong> ${errorMessage}
                        </div>
                    `;
                }
            });
        }
        
        const showNotification = (message, color) => {
             const chatContainer = document.querySelector('.flex-grow.flex-col');
             if (!chatContainer) return;
             
             const notification = document.createElement('div');
             notification.className = `absolute top-3 right-3 p-3 rounded-xl text-sm shadow-2xl z-50 bg-${color}-600 text-white`;
             notification.textContent = message;
             
             chatContainer.appendChild(notification);
             
             setTimeout(() => {
                 notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                 notification.addEventListener('transitionend', () => notification.remove());
             }, 3000);
        }

        const renderMessages = (messages) => {
            const chatBox = document.getElementById('chat-box');
            if (!chatBox) return;

            chatBox.innerHTML = '';
            
            messages.forEach(msg => {
                const isMine = msg.userId === userId;
                const messageContainer = document.createElement('div');
                messageContainer.className = `flex w-full ${isMine ? 'justify-end' : 'justify-start'} mb-3`;

                const messageBubble = document.createElement('div');
                
                const senderName = msg.displayName || (msg.userId ? `User-${msg.userId.substring(0, 4)}` : 'Unknown');

                messageBubble.className = `
                    max-w-[85%] sm:max-w-lg p-3 rounded-xl 
                    ${isMine 
                        ? 'bg-indigo-600 rounded-br-none text-white shadow-lg' 
                        : 'bg-gray-700/70 rounded-tl-none text-gray-100 shadow-md'}
                    
                `;

                const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';

                // Message Header (Sender Name and Time)
                const header = document.createElement('div');
                header.className = `flex items-baseline ${isMine ? 'justify-end' : 'justify-start'} mb-1`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = `font-bold text-sm ${isMine ? 'text-indigo-200' : 'text-green-400'}`;
                nameSpan.textContent = senderName;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-[10px] text-gray-400 ml-2';
                timeSpan.textContent = time;

                if (isMine) {
                    header.appendChild(timeSpan);
                    header.appendChild(nameSpan);
                } else {
                    header.appendChild(nameSpan);
                    header.appendChild(timeSpan);
                }
                
                messageBubble.appendChild(header);

                // Message Content (Text or Image)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content text-sm break-words';
                
                if (msg.isMedia) {
                    const img = document.createElement('img');
                    img.src = msg.text;
                    img.alt = "Shared image content";
                    img.className = 'object-cover rounded-lg mt-1 cursor-pointer transition-transform duration-200 hover:scale-[1.02]';
                    img.onerror = function() {
                        this.onerror=null; 
                        this.src = getPlaceholderUrl('Image Broken');
                        this.alt = 'Image URL failed to load.';
                        this.title = 'Image URL failed to load: ' + msg.text;
                        this.style.width = '200px';
                        this.style.height = '150px';
                    };
                    
                    img.onclick = () => window.open(msg.text, '_blank'); 

                    contentDiv.appendChild(img);
                } else {
                    contentDiv.textContent = msg.text;
                }

                messageBubble.appendChild(contentDiv);
                messageContainer.appendChild(messageBubble);
                chatBox.appendChild(messageContainer);
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        }


        window.sendMessage = async () => {
            if (!isAuthReady || !userId || !db) {
                showNotification("Error: Not authenticated or database not ready.", 'red');
                return;
            }

            const input = document.getElementById('message-input');
            const messageText = input.value.trim();

            if (messageText === '') return;

            input.value = ''; 
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let path;
            
            if (activeChatId === 'general') {
                path = `artifacts/${appId}/public/data/messages`; 
            } else {
                path = `artifacts/${appId}/public/data/dms/${activeChatId}/messages`; 
            }

            const isMedia = isMediaMode && isImageUrl(messageText);

            const messageData = {
                text: messageText,
                userId: userId,
                displayName: displayName,
                timestamp: serverTimestamp(),
                isMedia: isMedia
            };
            
            if (activeChatId !== 'general' && dmRecipientId) {
                 saveDmRecipient(userId, dmRecipientId, activeChatName.replace('DM: ', ''));
            }

            try {
                await addDoc(collection(db, path), messageData);
                if (isMediaMode) {
                    isMediaMode = false;
                    updateInputPlaceholder();
                }
                input.focus();
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification(`Send failed: ${error.message}`, 'red');
                input.value = messageText; 
            }
        }
        
        // --- Event Listeners and Initial Call ---

        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault(); 
                        window.sendMessage();
                    }
                });
            }
            
            updateChatHeaderUI();
        });

        initFirebaseAndChat();
    </script>

    <!-- UI STRUCTURE -->
    
    <!-- Loading State -->
    <div id="loading-state" class="absolute inset-0 flex items-center justify-center bg-[#2B2D31] z-50">
        <div class="text-xl text-indigo-400 animate-pulse flex items-center space-x-3">
             <svg class="w-6 h-6 animate-spin text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading Chat System...</span>
        </div>
    </div>

    <!-- Authentication Container (Shown on load or logout) -->
    <div id="auth-container" class="absolute inset-0 flex items-center justify-center bg-[#2B2D31] z-40">
        <div id="login-form" class="hidden bg-[#2B2D31] p-8 rounded-xl shadow-[0_20px_50px_rgba(0,0,0,0.8)] ring-4 ring-indigo-700/50 w-full max-w-sm">
            <h2 class="text-3xl font-extrabold text-white mb-2 text-center">Welcome to <span class="text-indigo-400">Dihcord</span></h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Sign in or create an account to start chatting.</p>
            
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 mb-4 bg-[#1E1F22] border-2 border-[#1E1F22] rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
            <input type="password" id="auth-password" placeholder="Password (min 6 chars)" class="w-full p-3 mb-6 bg-[#1E1F22] border-2 border-[#1E1F22] rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" required>
            
            <div id="auth-status" class="text-center text-sm mb-4 hidden font-medium"></div>

            <button onclick="handleAuthAction(false)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg hover:shadow-indigo-500/50 mb-3 transform hover:scale-[1.01]">
                Login
            </button>
            <button onclick="handleAuthAction(true)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg hover:shadow-green-500/50">
                Sign Up
            </button>
        </div>
    </div>

    <!-- Main Chat App Container (Hidden until authenticated) -->
    <div id="chat-app-container" class="flex flex-1 hidden">

        <!-- Sidebar (Channels & DMs) -->
        <div class="w-1/4 sm:w-[260px] bg-[#1E1F22] flex flex-col p-4 overflow-y-auto shadow-2xl custom-scroll flex-shrink-0">
            
            <!-- Logo/Title -->
            <h1 class="text-2xl font-extrabold text-white mb-6 border-b border-gray-700/50 pb-3">
                <span class="text-indigo-400">Dih</span>cord
            </h1>

            <!-- Channels -->
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Channels</h2>
            <button id="general-channel-button" onclick="switchChat('general', '# General Chat')" class="flex items-center w-full p-2 rounded-lg transition-colors bg-indigo-600/50 text-white font-semibold mb-4 hover:bg-indigo-600/70">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h10m-9 4h6m-3-6v4m-3-4h.01M17 16h.01M9 16h.01"></path></svg>
                <span class="truncate text-sm"># General Chat</span>
            </button>

            <!-- Direct Messages -->
            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Direct Messages</h2>
            <div id="dm-list-container" class="space-y-1 mb-6 flex-grow">
                <!-- DM buttons injected here -->
            </div>
            
            <!-- Start DM Input -->
            <div class="mt-auto pt-4 border-t border-gray-700/50">
                 <h3 class="text-xs font-bold text-gray-400 mb-2">Start DM by Name</h3>
                <div class="flex">
                    <input type="text" id="dm-recipient-input" placeholder="Enter user's name" class="flex-grow p-2 text-sm bg-gray-800 border-2 border-gray-700 rounded-l-lg text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500">
                    <button onclick="startDM()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-r-lg text-sm transition-colors font-medium">
                        DM
                    </button>
                </div>
            </div>

            <!-- User Info and Settings -->
            <div class="mt-4 pt-4 border-t border-gray-700/50">
                <div id="user-id-display" class="text-xs text-gray-400 mb-3 flex flex-col break-all font-mono p-2 bg-gray-900/50 rounded-lg shadow-inner"></div>
                
                <h3 class="text-xs font-bold text-gray-400 mb-2">Set Display Name</h3>
                <div class="flex mb-2">
                    <input type="text" id="new-display-name-input" class="flex-grow p-2 text-sm bg-gray-800 border-2 border-gray-700 rounded-l-lg text-white focus:outline-none focus:border-indigo-500" placeholder="Set your name">
                    <button onclick="setDisplayName()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-r-lg text-sm transition-colors font-medium">Set</button>
                </div>
                <div id="name-status" class="text-center text-xs hidden font-medium"></div>

                <button onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-200 text-sm transform hover:scale-[1.01] shadow-md">
                    Logout
                </button>
            </div>

        </div>

        <!-- Chat Area -->
        <div class="flex-grow flex flex-col relative bg-[#2B2D31]">

            <!-- Chat Header -->
            <header class="p-4 bg-[#2B2D31] border-b border-gray-700/50 shadow-lg flex-shrink-0 z-10">
                <h2 id="chat-header-name" class="text-xl font-bold text-white flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>
                    <span class="truncate"># General Chat</span>
                </h2>
                <p id="chat-header-desc" class="text-sm text-gray-400 truncate"></p>
            </header>

            <!-- Message Area -->
            <div id="chat-box" class="flex-grow p-4 overflow-y-auto space-y-4 custom-scroll-chat">
                <!-- Messages injected here -->
            </div>

            <!-- Message Input Area -->
            <div class="p-4 bg-[#2B2D31] border-t border-gray-700/50 flex-shrink-0 z-10">
                <div class="flex items-center bg-[#383A40] rounded-xl p-2 shadow-2xl">
                     <!-- Media Toggle Button -->
                    <button id="media-toggle-button" onclick="toggleMediaMode()" class="p-2 mr-3 rounded-full transition-colors text-gray-300 hover:bg-[#444754] flex-shrink-0" title="Toggle Media Mode (Paste URL)">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-9-6h.01M10 21h4a2 2 0 002-2v-4a2 2 0 00-2-2h-3l-4 4V5a2 2 0 012-2h2.5L10 21z"></path></svg>
                    </button>
                    
                    <input type="text" id="message-input" placeholder="Message # General Chat (Press Enter to send)" class="flex-grow bg-transparent text-white placeholder-gray-400 text-base focus:outline-none py-1" autofocus>
                    
                    <button onclick="sendMessage()" class="ml-3 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition duration-200 flex-shrink-0 transform hover:scale-[1.05]" title="Send Message">
                        <svg class="w-5 h-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.183l-3 3 7-14zM10 18a1 1 0 011-1h6a1 1 0 100-2h-6a1 1 0 01-1-1v-4a1 1 0 00-2 0v4a3 3 0 003 3z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
