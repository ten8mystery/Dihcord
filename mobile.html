<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nexus: Secure DMs (Mobile)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body {
  font-family: 'Inter', sans-serif;
  background-color: #111827;
  color: #f3f4f6;
}
#particle-canvas {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  z-index: -1;
}
</style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2">

<!-- Canvas background -->
<canvas id="particle-canvas"></canvas>

<!-- Authentication UI -->
<div id="auth-screen" class="w-full max-w-md bg-gray-900/50 rounded-xl p-4 shadow-lg z-10">
  <h1 class="text-3xl font-extrabold text-accent mb-4 text-center">Dihcord</h1>
  <!-- Toggle -->
  <div class="flex mb-4 rounded-xl bg-gray-800/50 p-1 shadow-inner">
    <button id="show-login-btn" class="flex-1 py-2 font-semibold rounded-lg transition duration-200 text-main bg-accent shadow-lg">Login</button>
    <button id="show-register-btn" class="flex-1 py-2 font-semibold rounded-lg transition duration-200 text-secondary hover:text-main">Register</button>
  </div>
  <!-- Login Form -->
  <div id="login-form" class="">
    <h2 class="text-2xl font-bold mb-2 text-center">Welcome Back!</h2>
    <input id="login-email" type="email" placeholder="Email" class="w-full p-3 mb-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" />
    <input id="login-password" type="password" placeholder="Password" class="w-full p-3 mb-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" />
    <p id="login-error" class="text-red-400 text-sm hidden">Error message</p>
    <button id="login-btn" class="w-full bg-accent py-3 rounded-lg text-white font-semibold shadow-lg hover:bg-green-600 transition duration-150">Log In</button>
  </div>
  <!-- Register Form -->
  <div id="register-form" class="hidden">
    <h2 class="text-2xl font-bold mb-2 text-center">Create Account</h2>
    <input id="register-email" type="email" placeholder="Email" class="w-full p-3 mb-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" />
    <input id="register-password" type="password" placeholder="Password (min 6)" class="w-full p-3 mb-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" />
    <p id="register-error" class="text-red-400 text-sm hidden">Error message</p>
    <button id="register-btn" class="w-full bg-accent py-3 rounded-lg text-white font-semibold shadow-lg hover:bg-green-600 transition duration-150">Register</button>
  </div>
</div>

<!-- Main Chat App -->
<div id="app" class="hidden flex-1 flex flex-col max-w-md rounded-xl overflow-hidden shadow-lg bg-gray-900/50">

  <!-- Chat Header -->
  <div id="chat-header" class="p-3 bg-sidebar flex items-center justify-center">
    <p class="text-secondary italic">Select a user to start chatting</p>
  </div>

  <!-- Message Container -->
  <div id="message-container" class="flex-1 overflow-y-auto p-4 space-y-2"></div>

  <!-- Message Input -->
  <div class="p-3 flex items-center space-x-2 border-t border-main bg-gray-800/50">
    <label for="image-upload-input" class="p-2 bg-gray-700 rounded-full cursor-pointer hover:bg-gray-600 transition duration-150">
      <svg class="h-6 w-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
      </svg>
    </label>
    <input type="file" id="image-upload-input" accept="image/*" class="hidden" />

    <input id="message-input" type="text" placeholder="Type message or select image" class="flex-1 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-accent" />

    <button id="send-button" class="p-3 bg-accent rounded-full hover:bg-green-600 transition duration-150">
      <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7" />
      </svg>
    </button>
  </div>
</div>

<script>
  // Initialize Firebase - replace with your config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  const authScreen = document.getElementById('auth-screen');
  const appDiv = document.getElementById('app');

  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const loginEmail = document.getElementById('login-email');
  const loginPassword = document.getElementById('login-password');
  const loginError = document.getElementById('login-error');
  const registerEmail = document.getElementById('register-email');
  const registerPassword = document.getElementById('register-password');
  const registerError = document.getElementById('register-error');

  // Auth toggle buttons
  document.getElementById('show-login-btn').onclick = () => {
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
  };
  document.getElementById('show-register-btn').onclick = () => {
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
  };

  // Firebase auth state listener
  onAuthStateChanged(auth, async user => {
    if (user) {
      authScreen.classList.add('hidden');
      appDiv.classList.remove('hidden');
      await loadUserProfile(user.uid);
    } else {
      authScreen.classList.remove('hidden');
      appDiv.classList.add('hidden');
    }
  });

  // Register
  document.querySelector('#register-btn').onclick = async () => {
    const email = registerEmail.value.trim();
    const password = registerPassword.value.trim();
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      // Create user profile document
      await setDoc(doc(db, 'users', cred.user.uid), {
        username: 'User' + Math.floor(Math.random()*1000),
        email: email,
        profilePicture: '', // default or placeholder URL
        recentDMs: {},
        theme: 'dark-default',
      });
    } catch (e) {
      registerError.textContent = e.message;
      registerError.classList.remove('hidden');
    }
  };

  // Login
  document.querySelector('#login-btn').onclick = async () => {
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      loginError.textContent = e.message;
      loginError.classList.remove('hidden');
    }
  };

  // Load user profile and initialize chat
async function loadUserProfile(uid) {
  const userRef = doc(db, 'users', uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) {
    // Create profile if not exists
    await setDoc(userRef, {
      username: 'User' + Math.floor(Math.random()*1000),
      email: auth.currentUser.email,
      profilePicture: '',
      recentDMs: {},
      theme: 'dark-default'
    });
  }
  // Show chat UI
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  startChat(uid);
}

let currentUserId = null;
let currentUserProfile = null;
let unsubscribeMessages = null;
let selectedUserId = null;

function startChat(uid) {
  currentUserId = uid;
  const userRef = doc(db, 'users', uid);
  onSnapshot(userRef, async snap => {
    currentUserProfile = snap.data();
    // Load user list
    loadUserList();
  });
}

async function loadUserList() {
  const usersRef = collection(db, 'users');
  const snap = await getDocs(usersRef);
  const users = snap.docs
    .filter(d => d.id !== currentUserId)
    .map(d => ({ id: d.id, ...d.data() }));
  renderUserList(users);
}

function renderUserList(users) {
  const container = document.getElementById('message-container');
  container.innerHTML = '';
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'p-2 bg-gray-800 rounded mb-2 cursor-pointer hover:bg-gray-700';
    div.innerHTML = `<div class="flex items-center space-x-2">
      <img src="${user.profilePicture || 'https://placehold.co/40x40/2d3748/ffffff?text=U'}" class="w-8 h-8 rounded-full"/>
      <div>
        <p class="text-white font-semibold">${user.username}</p>
        <p class="text-xs text-gray-400">ID: ${user.id}</p>
      </div>
    </div>`;
    div.onclick = () => startChatWith(user.id);
    container.appendChild(div);
  });
}

async function startChatWith(uid) {
  selectedUserId = uid;
  // Load messages
  const chatId = [currentUserId, uid].sort().join('_');
  const messagesRef = collection(db, 'chats', chatId, 'messages');

  if (unsubscribeMessages) unsubscribeMessages();
  unsubscribeMessages = onSnapshot(messagesRef, snap => {
    renderMessages(snap.docs);
  });

  // Load user info
  const userRef = doc(db, 'users', uid);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.data();

  // Render header
  document.getElementById('chat-header').innerHTML = `
    <img src="${userData.profilePicture || 'https://placehold.co/40x40/2d3748/ffffff?text=U'}" class="w-10 h-10 rounded-full"/>
    <div>
      <p class="text-white font-semibold">${userData.username}</p>
      <p class="text-xs text-gray-400">ID: ${uid}</p>
    </div>
  `;
}

function renderMessages(docs) {
  const container = document.getElementById('message-container');
  container.innerHTML = '';
  docs.forEach(doc => {
    const msg = doc.data();
    const isSender = msg.senderId === currentUserId;
    const bubbleHTML = `
      <div class="flex ${isSender ? 'justify-end' : 'justify-start'} items-end space-x-2 mb-2">
        ${!isSender ? `<img src="${currentUserProfile.profilePicture || 'https://placehold.co/40x40/2d3748/ffffff?text=U'}" class="w-8 h-8 rounded-full"/>` : ''}
        <div class="${isSender ? 'bg-green-600' : 'bg-gray-700'} p-3 rounded-lg max-w-xs break-words text-white">
          ${msg.type === 'image' ? `<img src="${msg.imageData}" class="max-w-full h-auto rounded mb-1 border border-gray-500"/>` : `<p>${msg.text}</p>`}
          <div class="text-xs text-gray-300 mt-1 text-right">${new Date(msg.timestamp.seconds * 1000).toLocaleTimeString()}</div>
        </div>
        ${isSender ? `<img src="${currentUserProfile.profilePicture || 'https://placehold.co/40x40/2d3748/ffffff?text=U'}" class="w-8 h-8 rounded-full"/>` : ''}
      </div>
    `;
    container.innerHTML += bubbleHTML;
  });
  container.scrollTop = container.scrollHeight;
}

// Send message
document.getElementById('send-button').onclick = async () => {
  const text = document.getElementById('message-input').value.trim();
  if (!text && !selectedImageData) return;
  const chatId = [currentUserId, selectedUserId].sort().join('_');
  const messagesRef = collection(db, 'chats', chatId, 'messages');

  const messageData = {
    senderId: currentUserId,
    timestamp: serverTimestamp(),
    type: 'text',
    text: text,
  };

  await addDoc(messagesRef, messageData);
  document.getElementById('message-input').value = '';
  selectedImageData = null;
};

// Image upload
let selectedImageData = null;
document.getElementById('image-upload-input').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    selectedImageData = reader.result;
    // Optional: Show preview
  };
  reader.readAsDataURL(file);
};
</script>
</body>
</html>
